version: "3.8"

services:
    # FastAPI application
    fastapi:
        build: .
        ports:
            - "8000:8000"
        environment:
            - ENVIRONMENT=development
            - DB_USER=postgres
            - DB_PASSWORD=password
            - DB_NAME=fastapi_db
            - DB_HOST=postgres
            - DB_PORT=5432
            # - REDIS_URL=redis://redis:6379  # Uncomment when Redis is needed
            - SECRET_KEY=your-secret-key-for-development-change-in-production
            # Firebase environment variables
            - FIREBASE_SERVICE_ACCOUNT_JSON=${FIREBASE_SERVICE_ACCOUNT_JSON}
            - GOOGLE_PROJECT_ID=ai-agent-hack
            - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}
        depends_on:
            - postgres
            # - redis  # Uncomment when Redis is needed
        volumes:
            - ./app:/app/app
        env_file:
            - .env
        command: ["/app/run_migrations.sh"]
        networks:
            - fastapi-network

    # PostgreSQL database
    postgres:
        image: postgres:15-alpine
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=password
            - POSTGRES_DB=fastapi_db
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
        networks:
            - fastapi-network

    # Redis for caching (commented out - uncomment when needed)
    # redis:
    #   image: redis:7-alpine
    #   ports:
    #     - "6379:6379"
    #   volumes:
    #     - redis_data:/data
    #   networks:
    #     - fastapi-network

    # Adminer for database management (optional)
    adminer:
        image: adminer
        ports:
            - "8080:8080"
        depends_on:
            - postgres
        networks:
            - fastapi-network

    # GCP Cloud SQL Proxy (commented out - uncomment for GCP deployment)
    # cloud-sql-proxy:
    #   image: gcr.io/cloudsql-docker/gce-proxy:1.33.2
    #   command: /cloud_sql_proxy -instances=${CLOUD_SQL_CONNECTION_NAME}=tcp:0.0.0.0:5432
    #   ports:
    #     - "5433:5432"
    #   volumes:
    #     - ${GOOGLE_APPLICATION_CREDENTIALS}:/config
    #   environment:
    #     - GOOGLE_APPLICATION_CREDENTIALS=/config
    #   profiles:
    #     - gcp
    #   networks:
    #     - fastapi-network

volumes:
    postgres_data:
    # redis_data:  # Uncomment when Redis is needed

networks:
    fastapi-network:
        driver: bridge
